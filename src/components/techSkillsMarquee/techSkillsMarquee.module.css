.marquee {
  view-transition-name: skillMarquee;
  container-type: inline-size;
  border-radius: var(--border-radius-md);
  container-name: marquee;
  transform-style: preserve-3d;
  width: 100%;
  margin-block: 2rem;
  margin-inline: auto;
  max-width: 720px;
  height: fit-content;
  grid-column: 1 / 4;
  &:has(a:focus-visible) {
    outline: 2px dashed var(--system-dark-100);
  }
}

.scene {
  --mask-width: 3rem;
  /* Inset and outset controls the grid animation offset on entry/exit */
  --inset: -0.5;
  --outset: 3.5;
  --speed: 10s;
  --items-in-row: 3;
  scroll-behavior: smooth;
  --grid-row-count: round(
    up,
    calc(var(--number-of-items) / var(--items-in-row))
  );
  overflow: hidden;
  width: 100%;
  height: calc((var(--grid-row-count) - 1) * 54px);
  mask: linear-gradient(
      transparent,
      white var(--mask-width) calc(100% - var(--mask-width)),
      transparent
    ),
    linear-gradient(
      90deg,
      transparent,
      white var(--mask-width) calc(100% - var(--mask-width)),
      transparent
    );
  mask-composite: intersect;
}

.skillsGrid {
  display: grid;
  transform-style: preserve-3d;
  height: 100%;
  width: fit-content;
  margin-block: 0;
  margin-inline: auto;
  list-style-type: none;
  position: relative;
  padding-left: 1rem;
  grid-template-columns: repeat(var(--items-in-row), 1fr);
  column-gap: 1rem;
  transition: transform 0.5s;
  /* 3D translation */
  transform: rotateX(48deg) rotateZ(-6deg) skewX(6deg);
  &:hover .skill,
  &:focus-within .skill {
    animation-play-state: paused;
  }
}

.skill {
  transform-style: preserve-3d;
  position: relative;
  z-index: calc(1 + var(--active));
  --transition: 150ms;
  --row-index: round(down, calc(var(--index) / var(--items-in-row)));
  --duration: calc(var(--speed) * 2);
  --delay: calc(
    (var(--duration) / var(--grid-row-count)) * (var(--row-index, 0) - 8)
  );
  @media (prefers-reduced-motion: no-preference) {
    /*Delay the animation to after fade in*/
    animation: slide var(--duration) calc(var(--delay) + 600ms) linear infinite;
    translate: 0%
      calc(
        ((var(--grid-row-count) - var(--row-index)) + var(--inset, 0)) * 100%
      );
  }
  &::before {
    content: '';
    position: absolute;
    inset: 4px 4px -2px -2px;
    border-radius: 40%;
    background: var(--system-shadow-1);
    filter: blur(calc(var(--active, 0.15) * 8px));
    z-index: -1;
    transition:
      scale var(--transition),
      opacity var(--transition),
      translate var(--transition),
      filter var(--transition);
    transform-origin: 50% 0;
    scale: 1 calc(1 + (var(--active, 0) * 0.05));
    box-shadow: var(--stacks-6-shadow);
  }
  &[data-placeholder]::before {
    background: var(--system-shadow-5);
    z-index: -2;
  }
  &:hover:not([data-placeholder]),
  &:focus-within:not([data-placeholder]),
  &:has(a[data-active]) {
    --active: 1;
  }
  & a {
    display: block;
    transition:
      transform var(--transition),
      scale var(--transition),
      background-color 0.25s,
      color 0.25s,
      border 0.25s,
      box-shadow 0.25s;
    scale: calc(1 + (var(--active, 0) * 0.1));
    transform: translateZ(calc(var(--active, 0) * 8px));
    &:focus-visible {
      border-radius: 30%;
      outline-offset: var(--outline-offset);
    }
  }
  & :global(.squircle) {
    clip-path: url(#squircle);
    display: block;

    &.outline {
      background-color: light-dark(
        var(--system-light-200),
        var(--system-light-500)
      );
    }
  }
}

a[data-active] {
  &::after {
    content: '';
    position: absolute;
    z-index: -1;
    inset: -4px;
    clip-path: url('#squircle');
    background-color: var(--system-dark-100);
  }
}

@container marquee (width >= 400px) {
  .scene {
    --items-in-row: 4;
    --speed: 9s;
  }
}

@container marquee (width >= 500px) {
  .scene {
    --items-in-row: 5;
    --speed: 8s;
  }
}

@container marquee (width >= 600px) {
  .scene {
    --items-in-row: 6;
    --speed: 7s;
  }
}

@keyframes slide {
  100% {
    translate: 0% calc((var(--row-index) + var(--outset, 0)) * -100%);
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

::view-transition-old(skillMarquee) {
  animation: 300ms fadeOut ease-in-out both;
}

::view-transition-new(skillMarquee) {
  animation: 300ms fadeIn 300ms ease-in-out both;
}
