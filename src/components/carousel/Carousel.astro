---
import styles from './carousel.module.css';
import { Picture } from 'astro:assets';
import type {
  ImageType,
  DanishDate,
  EnglishDate,
  ImageModule,
} from '@customTypes/index';
const newsImages = import.meta.glob('@assets/newsImages/*.{jpg,png}');

export type CardInfo = {
  title: string;
  description: string;
  date: EnglishDate | DanishDate;
  imageSrc: ImageType;
  imageAlt: string;
  href: string;
  outline: '1' | '2' | '3' | '4' | 'gold';
};

interface Props {
  labels: {
    title: string;
    /** Title of the archive card */
    archiveTitle: string;
    previous: string;
    next: string;
  };
  items: CardInfo[];
  /*Set a limit on items - this way an archive card will be rendered pointing to older news  */
  maxNumberOfItems?: number;
  inert: boolean;
}

const { items, maxNumberOfItems, labels, inert } = Astro.props;

const CAROUSEL_ID = 'carousel' as const;
const HEADING_ID = 'carousel_heading' as const;
const ARCHIVE_ID = 'newsArchive';
const ARCHIVE_HREF = 'news-archive';

const itemList =
  maxNumberOfItems && items.length > maxNumberOfItems
    ? items.slice(0, maxNumberOfItems)
    : items;

// const showArchiveCard = maxNumberOfItems && items.length > maxNumberOfItems;
const showArchiveCard = true;
---

<section
  aria-labelledby="carouselheading"
  id={CAROUSEL_ID}
  style={`--card-length: ${showArchiveCard ? itemList.length + 1 : itemList.length}`}
  inert={inert}
>
  <script>
    const { carouselList, previous, next } = window;

    /**
     * Scrolls the demo element to the left or right based on the id of the clicked button.
     */
    const handleScroll = (event: MouseEvent) => {
      const carouselCardWidth = carouselList?.querySelector('li')?.offsetWidth;

      if (
        carouselList &&
        carouselCardWidth &&
        event.currentTarget instanceof HTMLButtonElement
      ) {
        const direction = event.currentTarget?.id;
        carouselList?.scrollBy({
          left: direction === 'next' ? carouselCardWidth : -carouselCardWidth,
          behavior: 'smooth',
        });
      }
    };

    previous?.addEventListener('click', handleScroll, {
      passive: true,
    });
    next?.addEventListener('click', handleScroll, {
      passive: true,
    });

    /**
     * Updates the cursor position in the carousel wrapper element.
     */
    const updateCursor = (event: PointerEvent) => {
      if (carouselList) {
        carouselList.style.setProperty('--x', `${event.layerX}`);
        carouselList.style.setProperty('--y', `${event.layerY}`);
      }
    };

    carouselList?.addEventListener('pointermove', updateCursor, {
      passive: true,
    });
  </script>
  <h2 id={HEADING_ID}>{labels.title}</h2>
  <ul id="carouselList">
    {
      showArchiveCard && (
        <li style={`--index: ${0}`}>
          <a id={ARCHIVE_ID} href={`#${ARCHIVE_HREF}`}>
            <article class={styles[ARCHIVE_ID]}>
              <h3>{labels.archiveTitle}</h3>
            </article>
          </a>
        </li>
      )
    }
    {
      itemList.map(async (item, index) => {
        const imageName = item.imageSrc;
        const imageImport = Object.entries(newsImages).find(([path]) =>
          path.includes(imageName)
        );

        if (!imageImport) {
          console.error(`News image not found for: ${imageName}`);
          return null;
        }
        const ImageComponent = ((await imageImport[1]()) as ImageModule)
          .default;

        return (
          <li style={`--index: ${index + 1}`}>
            <a id={`card${index}`} href={`#${item.href}`}>
              <article class={styles[`outline${item.outline}`]}>
                <Picture
                  formats={['avif']}
                  quality="high"
                  src={ImageComponent}
                  alt={item.imageAlt}
                  width="232"
                  height="148"
                  densities={[1, 2, 3, 4]}
                  loading="lazy"
                  decoding="sync"
                />
                <div class={styles.newsContent}>
                  <div>
                    <h3>{item.title}</h3>
                    <p>{item.description}</p>
                  </div>
                  <div class={styles.date}>
                    <p>{item.date}</p>
                  </div>
                </div>
              </article>
            </a>
          </li>
        );
      })
    }
  </ul>
  <ul class={styles.controls}>
    <li>
      <button id="previous" aria-label={labels.previous}>
        <svg
          width="12"
          fill="currentColor"
          aria-hidden="true"
          viewBox="4.5 7 15 15"
        >
          <path d="m16 19-4.6-4.6 4.6-4.6-1.4-1.4-6 6 6 6z"></path>
        </svg>
      </button>
    </li>
    <li class={styles.indicators} aria-hidden="true">
      {itemList.map((_item, index) => <div style={`--index: ${index + 1}`} />)}
    </li>
    <hr />
    <li>
      <button id="next" aria-label={labels.next}>
        <svg
          width="12"
          fill="currentColor"
          aria-hidden="true"
          viewBox="4.5 7 15 15"
        >
          <path d="m8.3 9.9 4.6 4.6-4.6 4.6 1.4 1.4 6-6-6-6z"></path>
        </svg>
      </button>
    </li>
  </ul>
</section>
